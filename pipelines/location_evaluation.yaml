
title: "Simple location evaluation of public transport stops"
description: "Based on population and POI data around the stops"
steps:
  - step:
      title: "POI around stops"
      from: 
        table: stg.gtfs__stops
        options:
          geometry: geom
      with:
        table: stg.ovm__places
        options:
          geometry: geom
          id: id
      function:
        type: aggregate_within_buffer
        options:
          buffer_size: 300
          agg: "count(id) AS poi_count"
      to:
        table: stg.gtfs__stops_agg_buffer_poi

  - step:
      title: "Population around stops"
      from: 
        table: stg.gtfs__stops
        options:
          geometry: geom
      with:
        table: stg.worldpop__population
        options:
          geometry: geom
          id: id
      function:
        type: aggregate_within_buffer
        options:
          buffer_size: 300
          agg: "count(pop) AS pop_count"
      to:
        table: stg.gtfs__stops_agg_buffer_pop

  - step:
      title: "Generate H3 grid index for each stop"
      from:
        table: stg.gtfs__stops
        options: 
          geometry: geom
      function:
        type: generate_grid_h3
        options:
          h3_res: 6
      to:
        table: stg.gtfs__stops_h3

  - step:
      title: "Find three nearest stops"
      from:
        table: stg.gtfs__stops
        options: 
          geometry: geom
          id: stop_id
          table_alias: a
      with:
        table: stg.gtfs__stops
        options:
          geometry: geom
          id: stop_id
          table_alias: b
      function:
        type: find_nearest_n
        options:
          max_distance: 2000
          max_neighbours: 3
          # TODO tohle nejak nedobiha
          #where_condition: a.stop_id != b.stop_id
      to:
        table: stg.gtfs__stops_nearest

  - step:
      title: "Find average proximity to nearest stops"
      from:
        table: stg.gtfs__stops
        options: 
          geometry: geom
          id: stop_id
          table_alias: a
      with:
        table: stg.gtfs__stops
        options:
          geometry: geom
          id: stop_id
          table_alias: b
      function:
        type: find_nearest_avg
        options:
          max_distance: 2000
          max_neighbours: 3
          # TODO tohle nejak nedobiha
          #where_condition: a.stop_id != b.stop_id
      to:
        table: stg.gtfs__stops_proximity


    # TODO other function which will merge all KPIs and compute one final score